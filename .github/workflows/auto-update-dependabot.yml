name: Auto-Update Dependabot PRs

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 10 * * 1'  # Every Monday at 10:00 AM UTC

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  update-dependabot-prs:
    name: Update Dependabot PRs with develop
    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch all branches
        run: |
          git fetch --all --prune

      - name: Find and update Dependabot branches
        id: update_branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Finding Dependabot branches..."
          DEPENDABOT_BRANCHES=$(git branch -r | grep "origin/dependabot" | sed 's/origin\///' | tr -d ' ')

          if [ -z "$DEPENDABOT_BRANCHES" ]; then
            echo "No Dependabot branches found"
            echo "updated_branches=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found Dependabot branches:"
          echo "$DEPENDABOT_BRANCHES"

          UPDATED_BRANCHES=""
          FAILED_BRANCHES=""

          for BRANCH in $DEPENDABOT_BRANCHES; do
            echo "Processing branch: $BRANCH"

            # Get PR number for this branch
            PR_NUMBER=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number')

            if [ -z "$PR_NUMBER" ]; then
              echo "No PR found for branch $BRANCH, skipping"
              continue
            fi

            echo "Found PR #$PR_NUMBER for branch $BRANCH"

            # Check if PR is already up to date with develop
            PR_BASE=$(gh pr view "$PR_NUMBER" --json baseRefName --jq '.baseRefName')

            if [ "$PR_BASE" != "develop" ]; then
              echo "PR #$PR_NUMBER is not targeting develop (targets $PR_BASE), skipping"
              continue
            fi

            # Checkout the branch
            git checkout "$BRANCH" 2>/dev/null || git checkout -b "$BRANCH" "origin/$BRANCH"

            # Try to merge develop
            if git merge origin/develop --no-edit; then
              echo "Successfully merged develop into $BRANCH"

              # Push the updated branch
              if git push origin "$BRANCH"; then
                echo "Successfully pushed updated branch $BRANCH"
                UPDATED_BRANCHES="$UPDATED_BRANCHES $BRANCH"

                # Add comment to PR
                gh pr comment "$PR_NUMBER" --body "ðŸ¤– This branch has been automatically updated with the latest changes from \`develop\`."
              else
                echo "Failed to push branch $BRANCH"
                FAILED_BRANCHES="$FAILED_BRANCHES $BRANCH"
              fi
            else
              echo "Merge conflict detected in $BRANCH, skipping"
              git merge --abort
              FAILED_BRANCHES="$FAILED_BRANCHES $BRANCH"

              # Add comment about conflict
              gh pr comment "$PR_NUMBER" --body "âš ï¸ Unable to automatically update this branch with \`develop\` due to merge conflicts. Please resolve manually."
            fi

            # Return to main branch
            git checkout main
          done

          echo "updated_branches=$UPDATED_BRANCHES" >> $GITHUB_OUTPUT
          echo "failed_branches=$FAILED_BRANCHES" >> $GITHUB_OUTPUT

      - name: Summary
        if: always()
        run: |
          echo "## Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ steps.update_branches.outputs.updated_branches }}" ]; then
            echo "### âœ… Successfully Updated Branches:" >> $GITHUB_STEP_SUMMARY
            for BRANCH in ${{ steps.update_branches.outputs.updated_branches }}; do
              echo "- $BRANCH" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "${{ steps.update_branches.outputs.failed_branches }}" ]; then
            echo "### âŒ Failed Branches:" >> $GITHUB_STEP_SUMMARY
            for BRANCH in ${{ steps.update_branches.outputs.failed_branches }}; do
              echo "- $BRANCH" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -z "${{ steps.update_branches.outputs.updated_branches }}" ] && [ -z "${{ steps.update_branches.outputs.failed_branches }}" ]; then
            echo "No Dependabot branches found to update." >> $GITHUB_STEP_SUMMARY
          fi

  auto-merge-dependabot:
    name: Auto-merge passing Dependabot PRs
    runs-on: ubuntu-latest
    needs: update-dependabot-prs
    if: always()

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Auto-approve and merge Dependabot PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for Dependabot PRs ready to merge..."

          # Get all open Dependabot PRs targeting develop
          PRS=$(gh pr list --author "dependabot[bot]" --base develop --json number,headRefName,mergeable,statusCheckRollup --jq '.[] | select(.mergeable == "MERGEABLE") | select(.statusCheckRollup | length > 0) | select(.statusCheckRollup | all(.conclusion == "SUCCESS")) | .number')

          if [ -z "$PRS" ]; then
            echo "No Dependabot PRs ready to merge"
            exit 0
          fi

          echo "Found PRs ready to merge: $PRS"

          for PR in $PRS; do
            echo "Processing PR #$PR"

            # Check if all checks have passed
            CHECKS_STATUS=$(gh pr view "$PR" --json statusCheckRollup --jq '.statusCheckRollup[].conclusion')

            if echo "$CHECKS_STATUS" | grep -q "FAILURE\|CANCELLED\|TIMED_OUT"; then
              echo "PR #$PR has failing checks, skipping"
              continue
            fi

            if echo "$CHECKS_STATUS" | grep -q "PENDING\|IN_PROGRESS"; then
              echo "PR #$PR has pending checks, skipping"
              continue
            fi

            echo "All checks passed for PR #$PR, merging..."

            # Enable auto-merge
            if gh pr merge "$PR" --squash --auto; then
              echo "Successfully enabled auto-merge for PR #$PR"
              gh pr comment "$PR" --body "ðŸŽ‰ All checks passed! This PR will be automatically merged."
            else
              echo "Failed to enable auto-merge for PR #$PR"
            fi
          done

      - name: Merge Summary
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## Auto-Merge Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          MERGED=$(gh pr list --author "dependabot[bot]" --base develop --state merged --limit 10 --json number,title,mergedAt --jq '.[] | "- PR #\(.number): \(.title) (merged at \(.mergedAt))"')

          if [ -n "$MERGED" ]; then
            echo "### Recently Merged Dependabot PRs:" >> $GITHUB_STEP_SUMMARY
            echo "$MERGED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          OPEN=$(gh pr list --author "dependabot[bot]" --base develop --state open --json number,title --jq '.[] | "- PR #\(.number): \(.title)"')

          if [ -n "$OPEN" ]; then
            echo "### Open Dependabot PRs:" >> $GITHUB_STEP_SUMMARY
            echo "$OPEN" >> $GITHUB_STEP_SUMMARY
          else
            echo "No open Dependabot PRs remaining." >> $GITHUB_STEP_SUMMARY
          fi
